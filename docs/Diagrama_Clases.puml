@startuml PyroShop_Diagrama_Clases
!define ABSTRACTCOLOR #E1F5E1
!define CLASSCOLOR #E3F2FD
!define DATACOLOR #FFF3E0
!define COMPONENTCOLOR #F3E5F5

title Diagrama de Clases - PyroShop (Tienda de Pirotecnia)
note top : Estructura de componentes React + Modelos de datos Firebase

' ============ MODELOS DE DATOS FIREBASE ============
package "üìä Modelos Firestore" #DATACOLOR {
    class Usuario {
        --Atributos--
        id: string (uid)
        email: string
        nombre: string
        apellido: string
        telefono: string
        rol: enum[cliente, admin, vendedor]
        direccion: string
        ciudad: string
        estado: enum[activo, inactivo]
        fechaRegistro: timestamp
        ultimaActividad: timestamp
    }

    class Producto {
        --Atributos--
        id: string
        nombre: string
        descripcion: string
        precio: decimal
        precioOferta: decimal
        cantidad: integer
        categoria: string
        imagenUrl: string
        estado: enum[disponible, descontinuado]
        destacado: boolean
        etiquetas: array[string]
        fechaCreacion: timestamp
    }

    class Categoria {
        --Atributos--
        id: string
        nombre: string
        descripcion: string
        imagen: string
        estado: enum[activo, inactivo]
    }

    class Pedido {
        --Atributos--
        id: string
        usuarioId: string (FK ‚Üí Usuario)
        fecha: timestamp
        estado: enum[pendiente, procesando, enviado, entregado, cancelado]
        total: decimal
        subtotal: decimal
        impuestos: decimal
        envio: decimal
        direccionEnvio: string
        metodoPago: string
        items: array[LineaPedido]
    }

    class LineaPedido {
        --Atributos--
        productoId: string (FK ‚Üí Producto)
        nombre: string
        precio: decimal
        cantidad: integer
        subtotal: decimal
    }

    class Carrito {
        --Atributos--
        usuarioId: string (FK ‚Üí Usuario)
        items: array[LineaCarrito]
        total: decimal
        ultimaActualizacion: timestamp
    }

    class LineaCarrito {
        --Atributos--
        productoId: string (FK ‚Üí Producto)
        cantidad: integer
        precioUnitario: decimal
    }

    class Auditoria {
        --Atributos--
        id: string
        usuario: string
        accion: string
        resultado: string
        fecha: timestamp
        ip: string
    }

    class ZonaEnvio {
        --Atributos--
        id: string
        nombre: string
        costo: decimal
        tiempoEntrega: integer (dias)
        estado: enum[activo, inactivo]
    }

    class Evento {
        --Atributos--
        id: string
        nombre: string
        fecha: date
        hora: time
        tipo: string
        estado: enum[confirmado, pendiente, cancelado]
        descripcion: string
        productosAsociados: array[string]
    }

    class Oferta {
        --Atributos--
        id: string
        nombre: string
        descripcion: string
        descuento: decimal
        porcentajeDescuento: decimal
        fechaInicio: date
        fechaFin: date
        productosAsociados: array[string]
        estado: enum[activo, inactivo]
    }

    class RateLimit {
        --Atributos--
        userId: string (FK ‚Üí Usuario)
        count: integer
        lastReset: timestamp
        updatedAt: timestamp
    }

    class Backup {
        --Atributos--
        timestamp: timestamp
        version: string
        colecciones: map[string, array]
        ruta: string (Cloud Storage)
    }
}

' Relaciones de BD
Pedido --> Usuario : "usuarioId"
Pedido --> LineaPedido : "contiene"
LineaPedido --> Producto : "referenc√≠a"
Carrito --> Usuario : "usuarioId"
Carrito --> LineaCarrito : "contiene"
LineaCarrito --> Producto : "referenc√≠a"
Evento --> Producto : "asocia"
Oferta --> Producto : "aplica"
RateLimit --> Usuario : "controla"

' ============ COMPONENTES REACT ============
package "‚öõÔ∏è Componentes React" #COMPONENTCOLOR {

    interface IComponente {
        {abstract} render()
        {abstract} handleChange()
        {abstract} handleSubmit()
    }

    ' Layout & Navigation
    class MainLayout {
        --Props--
        children: ReactNode
        --M√©todos--
        render()
    }

    class Navbar {
        --State--
        user: Usuario | null
        cartItems: number
        --Props--
        onLogout()
        onNavigate()
        --M√©todos--
        renderNavLinks()
        renderUserMenu()
    }

    class Footer {
        --Props--
        --M√©todos--
        renderLinks()
        renderSocial()
    }

    ' P√°ginas P√∫blicas
    class LoginPage {
        --State--
        email: string
        password: string
        loading: boolean
        error: string
        --M√©todos--
        handleLogin()
        handleRegisterLink()
    }

    class RegisterPage {
        --State--
        formData: object
        loading: boolean
        error: string
        --M√©todos--
        handleRegister()
        validateForm()
        handleLoginLink()
    }

    class ForgotPasswordPage {
        --State--
        email: string
        --M√©todos--
        handleRecovery()
    }

    class ResetPasswordPage {
        --State--
        newPassword: string
        confirmPassword: string
        --M√©todos--
        handleReset()
    }

    ' P√°ginas Cliente
    class DashboardPage {
        --State--
        productos: array[Producto]
        destacados: array[Producto]
        loading: boolean
        --M√©todos--
        cargarProductos()
        filtrarDestacados()
        handleNavigateToCatalogo()
    }

    class CategoriasAdmin {
        --State--
        categorias: array[Categoria]
        filtros: object
        --M√©todos--
        cargarCategorias()
        agregarCategoria()
        editarCategoria()
        eliminarCategoria()
    }

    class Inventario {
        --State--
        productos: array[Producto]
        paginaActual: number
        filtros: object
        --M√©todos--
        cargarProductos()
        agregarProducto()
        editarProducto()
        eliminarProducto()
        subirImagen()
        paginar()
    }

    class Carrito {
        --State--
        items: array[LineaCarrito]
        total: decimal
        --M√©todos--
        agregarAlCarrito()
        quitarDelCarrito()
        modificarCantidad()
        calcularTotal()
    }

    class Checkout {
        --State--
        datosEnvio: object
        metodoPago: string
        total: decimal
        --M√©todos--
        validarDatos()
        procesarPago()
        crearPedido()
    }

    class Pedidos {
        --State--
        pedidos: array[Pedido]
        --M√©todos--
        cargarPedidos()
        cambiarEstadoPedido()
        descargarFactura()
    }

    ' P√°ginas Admin
    class Admin {
        --State--
        usuario: Usuario
        menu: array[string]
        --M√©todos--
        renderMenu()
        navegarA()
    }

    class DashboardAdmin {
        --State--
        ventasHoy: decimal
        ventasMes: decimal
        pedidosPendientes: integer
        --M√©todos--
        cargarMetricas()
        renderGraficos()
    }

    class BackupAdmin {
        --State--
        backups: array[Backup]
        --M√©todos--
        listarBackups()
        descargarBackup()
        restaurarBackup()
    }

    class Auditoria {
        --State--
        logs: array[Auditoria]
        filtros: object
        --M√©todos--
        cargarLogs()
        filtrarLogs()
        exportarLogs()
    }

    ' P√°ginas Informativos
    class PoliticaPrivacidad {
        --M√©todos--
        renderContenido()
    }

    class TerminosCondiciones {
        --M√©todos--
        renderContenido()
    }

    class NormativaRegulacion {
        --M√©todos--
        renderContenido()
    }

    class HelpCenter {
        --State--
        faqs: array[object]
        --M√©todos--
        buscarFAQ()
        enviarConsulta()
    }

    ' Componentes Reutilizables
    class ProtectedRoute {
        --Props--
        element: ReactElement
        requiredRole: string
        --M√©todos--
        validateUser()
        renderElement()
    }

    class Spinner {
        --Props--
        message: string
        --M√©todos--
        showLoading()
    }

    class NotFoundPage {
        --M√©todos--
        renderNotFound()
    }

    class EventsPage {
        --State--
        eventos: array[Evento]
        filtros: object
        --M√©todos--
        cargarEventos()
        filtrarEventos()
        confirmarAsistencia()
    }

    class GaleriaFotos {
        --State--
        imagenes: array[string]
        --Props--
        producto: Producto
        --M√©todos--
        cargarImagenes()
        mostrarImagenGrande()
    }

    class OfertasPirotecnia {
        --State--
        ofertas: array[Oferta]
        --M√©todos--
        cargarOfertas()
        aplicarOferta()
    }

    class Gracias {
        --Props--
        pedidoId: string
        --M√©todos--
        mostrarConfirmacion()
    }
}

' Relaciones entre componentes
IComponente <|-- LoginPage
IComponente <|-- RegisterPage
IComponente <|-- DashboardPage
IComponente <|-- Inventario
IComponente <|-- Carrito
IComponente <|-- Checkout

MainLayout --> Navbar : "usa"
MainLayout --> Footer : "usa"
DashboardPage --> Producto : "muestra"
Inventario --> Producto : "gestiona"
Carrito --> LineaCarrito : "contiene"
Checkout --> Carrito : "procesa"
Pedidos --> Pedido : "muestra"
ProtectedRoute --> LoginPage : "redirige si no auth"
Admin --> DashboardAdmin : "accede"
Admin --> BackupAdmin : "accede"
Admin --> Auditoria : "accede"
EventsPage --> Evento : "muestra"
OfertasPirotecnia --> Oferta : "muestra"

' ============ SERVICIOS ============
package "üîß Servicios" #COMPONENTCOLOR {
    class auditoriaService {
        {static} registrarLog(accion, resultado, ip)
        {static} obtenerLogs(usuarioId)
    }

    class backupService {
        {static} listarBackups()
        {static} descargarBackup(backupId)
        {static} restaurarBackup(backupId)
        {static} getBackupStats()
    }

    class responsiveImageHelper {
        {static} generateSrcSet(url, tipo, nombre)
        {static} getResponsiveImageProps(url, tipo, nombre)
        {static} addCloudinaryParams(url, ancho, alto)
    }

    class retryHelper {
        {static} retryAsyncSmartly(fn, intentos, delay)
    }
}

' Relaciones de servicios
LoginPage --> auditoriaService : "usa"
Inventario --> responsiveImageHelper : "usa"
DashboardPage --> responsiveImageHelper : "usa"
BackupAdmin --> backupService : "usa"

' ============ CLOUD FUNCTIONS ============
package "‚òÅÔ∏è Cloud Functions" #COMPONENTCOLOR {
    class cleanupAuditoria {
        {static} onSchedule() : scheduled (diario 2 AM UTC)
        {static} eliminarLogsAntiguos(dias)
    }

    class cleanupPedidosCancelados {
        {static} onSchedule() : scheduled (lunes 3 AM UTC)
        {static} eliminarPedidos(estado, dias)
    }

    class cleanupSesiones {
        {static} onSchedule() : scheduled (cada 6 horas)
        {static} eliminarSesionesExpiradas(dias)
    }

    class backupAdminConfig {
        {static} onSchedule() : scheduled (domingos 1 AM UTC)
        {static} crearBackup(colecciones)
        {static} limpiarBackupsAntiguos(dias)
    }

    class updateRateLimitCounter {
        {static} onWrite(change, context) : trigger Firestore
        {static} incrementarContador(userId)
        {static} resetearContador(userId)
    }
}

cleanupAuditoria --> Auditoria : "limpia"
cleanupPedidosCancelados --> Pedido : "limpia"
backupAdminConfig --> Backup : "crea"
updateRateLimitCounter --> RateLimit : "actualiza"

@enduml
